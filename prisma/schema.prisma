generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ESTRUTURA ORGANIZACIONAL ---

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos Hierárquicos
  roleId       String?
  role         Role?    @relation(fields: [roleId], references: [id])
  
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  // Gestão Direta (Quem é meu chefe?)
  managerId    String?
  manager      User?    @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates User[]   @relation("ManagerSubordinates")

  // Deputy (Meu substituto oficial)
  myDeputyId   String?
  myDeputy     User?    @relation("UserDeputy", fields: [myDeputyId], references: [id])
  deputyOf     User[]   @relation("UserDeputy")

  // Solicitações
  requestsMade     Request[] @relation("Requester")
  requestsApproved Request[] @relation("Approver")

  // Ferramentas que é dono (Owner)
  toolsOwned    Tool[] @relation("ToolOwner")
  toolsSubOwned Tool[] @relation("ToolSubOwner")
}

model Department {
  id    String @id @default(uuid())
  name  String @unique
  roles Role[]
  users User[]
}

model Role {
  id           String     @id @default(uuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  users        User[]
}

// --- FERRAMENTAS & ACESSOS ---

model Tool {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  
  ownerId     String?
  owner       User?   @relation("ToolOwner", fields: [ownerId], references: [id])
  
  subOwnerId  String?
  subOwner    User?   @relation("ToolSubOwner", fields: [subOwnerId], references: [id])
}

// --- SOLICITAÇÕES (WORKFLOW) ---

model Request {
  id              String   @id @default(uuid())
  type            String   // 'ACCESS_TOOL', 'CHANGE_ROLE', 'NOMINATE_DEPUTY', etc.
  status          String   // 'PENDENTE_GESTOR', 'PENDENTE_OWNER', 'APROVADO', 'REPROVADO'
  
  details         String   // JSON string com os dados (ferramenta, nível de acesso, etc)
  justification   String?
  isExtraordinary Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Quem pediu
  requesterId     String
  requester       User     @relation("Requester", fields: [requesterId], references: [id])

  // Quem aprovou por último
  approverId      String?
  approver        User?    @relation("Approver", fields: [approverId], references: [id])
  
  currentApproverRole String? // 'MANAGER', 'OWNER', 'SI_ANALYST'
}