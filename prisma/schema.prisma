// --- CONFIGURAÇÃO DO BANCO ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --- ESTRUTURA ORGANIZACIONAL ---

model Department {
  id    String @id @default(uuid())
  name  String
  roles Role[]
  users User[]
}

model Role {
  id           String     @id @default(uuid())
  name         String
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String
  users        User[]
}

model User {
  id           String      @id @default(uuid())
  name         String
  email        String      @unique 
  role         Role?       @relation(fields: [roleId], references: [id])
  roleId       String?
  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId String?

  // --- HIERARQUIA (Novo: Quem é o chefe de quem) ---
  managerId     String?
  manager       User?       @relation("Manager", fields: [managerId], references: [id])
  directReports User[]      @relation("Manager")

  // --- RELAÇÕES DO SISTEMA IGA ---
  requests      Request[]   @relation("Requester") // Pedidos que ele fez
  approvals     Request[]   @relation("Approver")  // Pedidos que ele aprovou (Rastreabilidade)
  toolsOwned    Tool[]      @relation("ToolOwner") // Ferramentas que ele é dono
}

// --- FERRAMENTAS E ACESSOS (ENTERPRISE) ---

model Tool {
  id           String   @id @default(uuid())
  name         String
  description  String?
  ownerId      String?
  owner        User?    @relation("ToolOwner", fields: [ownerId], references: [id])
  
  // Campo JSON para guardar níveis (Ex: Admin, Member, Guest)
  accessLevels String? 
}

// --- CORE: SOLICITAÇÕES DE ACESSO ---

model Request {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Quem pediu
  requesterId String
  requester   User   @relation("Requester", fields: [requesterId], references: [id])

  // Dados do Pedido
  type                String // CHANGE_ROLE ou ACCESS_TOOL
  status              String // PENDENTE_SI, PENDENTE_RH, APROVADO, REPROVADO
  currentApproverRole String // SI, RH, OWNER, CONCLUIDO
  
  details       String // JSON string com detalhes (Ex: Qual ferramenta, qual nível)
  justification String

  // Rastreabilidade (Quem aprovou/reprovou por último)
  lastApproverId String?
  lastApprover   User?   @relation("Approver", fields: [lastApproverId], references: [id])
}

// --- AUDITORIA ---

model AuditLog {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  action     String
  targetUser String
  executor   String
  details    String
}