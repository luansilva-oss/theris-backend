generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ESTRUTURA ORGANIZACIONAL ---

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String
  
  // ðŸ‘‡ CAMPO NOVO ADICIONADO PARA CORRIGIR O ERRO
  systemProfile  String   @default("VIEWER") 

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacionamentos HierÃ¡rquicos
  roleId         String?
  role           Role?    @relation(fields: [roleId], references: [id])
   
  departmentId   String?
  department     Department? @relation(fields: [departmentId], references: [id])

  // GestÃ£o Direta (Quem Ã© meu chefe?)
  managerId      String?
  manager        User?    @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates   User[]   @relation("ManagerSubordinates")

  // Deputy (Meu substituto oficial)
  myDeputyId     String?
  myDeputy       User?    @relation("UserDeputy", fields: [myDeputyId], references: [id])
  deputyOf       User[]   @relation("UserDeputy")

  // SolicitaÃ§Ãµes
  requestsMade     Request[] @relation("Requester")
  requestsApproved Request[] @relation("Approver")

  // Ferramentas que Ã© dono (Owner)
  toolsOwned     Tool[] @relation("ToolOwner")
  toolsSubOwned  Tool[] @relation("ToolSubOwner")
}

model Department {
  id    String @id @default(uuid())
  name  String @unique
  roles Role[]
  users User[]
}

model Role {
  id           String     @id @default(uuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  users        User[]
}

// --- FERRAMENTAS & ACESSOS ---

model Tool {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
   
  ownerId     String?
  owner       User?   @relation("ToolOwner", fields: [ownerId], references: [id])
   
  subOwnerId  String?
  subOwner    User?   @relation("ToolSubOwner", fields: [subOwnerId], references: [id])
}

// --- SOLICITAÃ‡Ã•ES (WORKFLOW) ---

model Request {
  id              String   @id @default(uuid())
  type            String   // 'ACCESS_TOOL', 'CHANGE_ROLE', 'NOMINATE_DEPUTY', etc.
  status          String   // 'PENDENTE_GESTOR', 'PENDENTE_OWNER', 'APROVADO', 'REPROVADO'
   
  details         String   // JSON string com os dados (ferramenta, nÃ­vel de acesso, etc)
  justification   String?
  isExtraordinary Boolean  @default(false)
   
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Quem pediu
  requesterId     String
  requester       User     @relation("Requester", fields: [requesterId], references: [id])

  // Quem aprovou por Ãºltimo
  approverId      String?
  approver        User?    @relation("Approver", fields: [approverId], references: [id])
   
  currentApproverRole String? // 'MANAGER', 'OWNER', 'SI_ANALYST'
}