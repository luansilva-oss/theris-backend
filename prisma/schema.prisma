generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// (Opcional: Pode manter ou remover Department/Role se não estiver usando ativamente, 
// mas desconectei do User para facilitar o CSV)
model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  roles     Role[]
}

model Role {
  id           String     @id @default(uuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  
  // --- MUDANÇA 1: Simplificado para facilitar importação do CSV ---
  department    String?   // Agora é texto simples (Ex: "Comercial")
  jobTitle      String?   // Cargo (Ex: "SDR")
  active         Boolean   @default(true) // NOVO: Flag de bloqueio para manter histórico (Demissão)
  // ---------------------------------------------------------------

  // Hierarquia (Gestor)
  managerId     String?
  manager       User?     @relation("ManagerToSubordinate", fields: [managerId], references: [id])
  subordinates  User[]    @relation("ManagerToSubordinate")
  
  // Deputado/Substituto
  myDeputyId    String?   @unique
  myDeputy      User?     @relation("DeputyRelation", fields: [myDeputyId], references: [id])
  deputyOf      User?     @relation("DeputyRelation")

  // Ferramentas
  toolsOwned    Tool[]    @relation("ToolOwner")
  toolsSubOwned Tool[]    @relation("ToolSubOwner")

  // Acessos
  accesses      Access[]

  // Solicitações
  requests      Request[] @relation("Requester") // Quem pediu
  approvals     Request[] @relation("Approver")  // Quem aprovou (NOVO PARA AUDITORIA)

  // Perfil de Sistema (RBAC)
  systemProfile String    @default("VIEWER")

  // MFA
  mfaCode       String?   
  mfaExpiresAt  DateTime? 
}

model Tool {
  id                  String   @id @default(uuid())
  name                String
  acronym             String?  // Nomenclatura (ex: "JC", "AWS")
  description         String?  // Breve descrição da ferramenta
  
  ownerId             String?
  owner               User?    @relation("ToolOwner", fields: [ownerId], references: [id])
  
  subOwnerId          String?
  subOwner            User?    @relation("ToolSubOwner", fields: [subOwnerId], references: [id])

  accesses            Access[]

  // Novos campos para edição
  toolGroupId         String?
  toolGroup           ToolGroup? @relation(fields: [toolGroupId], references: [id])
  
  availableAccessLevels String[] @default(["Admin", "User", "Viewer"]) // Níveis disponíveis para esta ferramenta
  accessLevelDescriptions Json? // Mapeamento { "Admin": "Descrição...", "User": "..." }

  criticality         String?  // Nível de criticidade (Alta, Média, Baixa)
  isCritical          Boolean  @default(false)

  createdAt           DateTime @default(now())
}

model ToolGroup {
  id    String @id @default(uuid())
  name  String @unique
  tools Tool[]
}

model Access {
  id        String   @id @default(uuid())
  status    String   @default("ACTIVE") 
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  toolId    String
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  // Detalhes Extraordinários
  isExtraordinary Boolean   @default(false)
  duration        Int?      
  unit            String?   // horas, dias, meses
  expiresAt       DateTime? 
}

model Request {
  id                  String   @id @default(uuid())
  
  requesterId         String?
  requester           User?    @relation("Requester", fields: [requesterId], references: [id], onDelete: SetNull)
  
  // --- MUDANÇA 2: Campos para Auditoria ---
  approverId          String?
  approver            User?    @relation("Approver", fields: [approverId], references: [id], onDelete: SetNull)
  adminNote           String?  // O motivo da aprovação/reprovação
  // ----------------------------------------

  type                String
  status              String   @default("PENDENTE_GESTOR")
  
  currentApproverRole String? 
  
  details             String   // JSON string
  justification       String?
  isExtraordinary     Boolean  @default(false)
  extraordinaryDuration Int?     // Ex: 48
  extraordinaryUnit     String?  // Ex: "horas", "dias", "meses"
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}