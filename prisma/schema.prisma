// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Department {
  id    String @id @default(uuid())
  name  String
  roles Role[]
  users User[]
}

model Role {
  id           String     @id @default(uuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  users        User[]
}

model User {
  id           String      @id @default(uuid())
  name         String
  email        String      @unique
  roleId       String
  role         Role        @relation(fields: [roleId], references: [id])
  departmentId String
  department   Department  @relation(fields: [departmentId], references: [id])
  managerId    String?
  manager      User?       @relation("Manager", fields: [managerId], references: [id])
  team         User[]      @relation("Manager")
  
  // --- NOVOS CAMPOS ---
  deputyId     String?     // O "Vice" do Gestor
  deputy       User?       @relation("Deputy", fields: [deputyId], references: [id]) // Quem é meu deputy
  deputyOf     User[]      @relation("Deputy") // De quem sou deputy
  
  requests     Request[]   @relation("Requester")
  approvals    Request[]   @relation("Approver")
  
  toolsOwned    Tool[]     @relation("ToolOwner")
  toolsSubOwned Tool[]     @relation("ToolSubOwner") // Novo
}

model Tool {
  id           String  @id @default(uuid())
  name         String
  description  String?
  
  ownerId      String?
  owner        User?   @relation("ToolOwner", fields: [ownerId], references: [id])
  
  // --- NOVO CAMPO ---
  subOwnerId   String?
  subOwner     User?   @relation("ToolSubOwner", fields: [subOwnerId], references: [id])
  
  accessLevels String  // JSON string: { create: [...], view: [...] }
}

model Request {
  id                  String   @id @default(uuid())
  requesterId         String
  requester           User     @relation("Requester", fields: [requesterId], references: [id])
  
  type                String   // 'CHANGE_ROLE', 'ACCESS_TOOL', 'NOMINATE_DEPUTY' (Novo)
  
  // Detalhes técnicos
  details             String   // JSON: { toolId, accessLevel, targetUserId, etc }
  justification       String
  isExtraordinary     Boolean  @default(false) // Flag de acesso fora do padrão
  
  // Controle de Aprovação
  status              String   // Enum simulado abaixo
  lastApproverId      String?
  lastApprover        User?    @relation("Approver", fields: [lastApproverId], references: [id])
  currentApproverRole String   // 'MANAGER', 'OWNER', 'SUB_OWNER', 'SI'
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// Model de Log para auditoria (simplificado)
model AuditLog {
  id        String   @id @default(uuid())
  action    String
  details   String
  createdAt DateTime @default(now())
}